name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          uv sync --dev

      - name: Run tests
        run: |
          uv run pytest tests/ -v --tb=short

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: |
          uv sync --dev

      - name: Run ruff check
        run: |
          uv run ruff check me/ --output-format=github

      - name: Run ruff format check
        run: |
          uv run ruff format me/ --check

  type-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: |
          uv pip install pyright
          uv sync --dev

      - name: Run type checking
        run: |
          uv run pyright me/ --outputjson || true  # Don't fail on type errors yet
        continue-on-error: true

  # Agent evaluation - runs on develop branch merges
  evaluate:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    needs: [test, lint]  # Only run if tests and lint pass

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: |
          uv sync --dev

      - name: Create eval directory
        run: mkdir -p eval_results

      - name: Run agent evaluation
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          AGENT_VERSION: ${{ github.sha }}
        run: |
          # Run evaluation with API if key is available, otherwise placeholder
          if [ -n "$ANTHROPIC_API_KEY" ]; then
            echo "Running evaluation with API..."
            uv run python -m me.agent.eval_runner \
              --output eval_results/report.md \
              --format markdown \
              --body-dir eval_results/body \
              --timeout 120 \
              --ci
          else
            echo "Running evaluation in placeholder mode (no API key)..."
            uv run python -m me.agent.eval_runner \
              --output eval_results/report.md \
              --format markdown \
              --body-dir eval_results/body \
              --skip-api
          fi

      - name: Generate JSON report
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          if [ -n "$ANTHROPIC_API_KEY" ]; then
            uv run python -m me.agent.eval_runner \
              --output eval_results/report.json \
              --format json \
              --body-dir eval_results/body \
              --skip-api  # Use cached results
          else
            uv run python -m me.agent.eval_runner \
              --output eval_results/report.json \
              --format json \
              --body-dir eval_results/body \
              --skip-api
          fi

      - name: Upload evaluation report
        uses: actions/upload-artifact@v4
        with:
          name: agent-evaluation-report
          path: |
            eval_results/report.md
            eval_results/report.json
          retention-days: 90

      - name: Post evaluation summary to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('eval_results/report.md', 'utf8');

            // Extract summary section
            const summaryMatch = report.match(/## Summary[\s\S]*?(?=##|$)/);
            const summary = summaryMatch ? summaryMatch[0] : 'No summary available';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Agent Evaluation Results\n\n${summary}\n\n[View full report](${context.payload.repository.html_url}/actions/runs/${context.runId})`
            });

  # Evaluation on PR (lighter version - placeholder only)
  evaluate-pr:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: [test]

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: |
          uv sync --dev

      - name: Run placeholder evaluation
        run: |
          mkdir -p eval_results
          uv run python -m me.agent.eval_runner \
            --output eval_results/report.md \
            --format markdown \
            --skip-api

      - name: Upload PR evaluation report
        uses: actions/upload-artifact@v4
        with:
          name: pr-evaluation-report
          path: eval_results/report.md
          retention-days: 7
